{% extends 'base.html' %}
{% load static %}

{% block title %}Reportes{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Reportes</h1>

<!-- FILTROS -->
<form method="get" class="bg-white p-4 mb-4 rounded shadow grid grid-cols-1 md:grid-cols-4 gap-4">

    <input
        type="text"
        name="q"
        value="{{ request.GET.q }}"
        placeholder="Nombre, IP o Referencia"
        class="border rounded px-3 py-2 w-full"
    >

    <select name="estatus" class="border rounded px-3 py-2 w-full">
        <option value="">Todos</option>
        <option value="1" {% if request.GET.estatus == '1' %}selected{% endif %}>Abiertos</option>
        <option value="2" {% if request.GET.estatus == '2' %}selected{% endif %}>Cerrados</option>
    </select>

    <input
        type="date"
        name="fecha_inicio"
        value="{{ request.GET.fecha_inicio }}"
        class="border rounded px-3 py-2 w-full"
    >

    <input
        type="date"
        name="fecha_fin"
        value="{{ request.GET.fecha_fin }}"
        class="border rounded px-3 py-2 w-full"
    >

    <div class="md:col-span-4 flex gap-2">
        <button
            type="submit"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"
        >
            Filtrar
        </button>

        <a
            href="{% url 'reportes' %}"
            class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition"
        >
            Limpiar
        </a>
    </div>
</form>

<!-- TABLA -->
<table class="min-w-full bg-white shadow rounded">
    <thead>
        <tr>
            <th class="py-2 px-4 border-b text-left">ID</th>
            <th class="py-2 px-4 border-b text-left">Nombre</th>
            <th class="py-2 px-4 border-b text-left">IP</th>
            <th class="py-2 px-4 border-b text-left"># Reporte</th>
            <th class="py-2 px-4 border-b text-left">Referencia Caída</th>
            <th class="py-2 px-4 border-b text-left">Fecha de Creación</th>
            <th class="py-2 px-4 border-b text-left">Quién Creó</th>
            <th class="py-2 px-4 border-b text-left">Observaciones</th>
            <th class="py-2 px-4 border-b text-left">Personal en Sitio</th>
            <th class="py-2 px-4 border-b text-left">Fecha Levanta</th>
            <th class="py-2 px-4 border-b text-left">Observaciones Finales</th>
            <th class="py-2 px-4 border-b text-left">Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for r in reportes %}
        <tr class="hover:bg-gray-100">
            <td class="py-2 px-4 border-b">{{ r.id }}</td>
            <td class="py-2 px-4 border-b">{{ r.nombre }}</td>
            <td class="py-2 px-4 border-b font-mono">{{ r.ip }}</td>
            <td class="py-2 px-4 border-b">{{ r.servicio|default_if_none:"" }}</td>
            <td class="py-2 px-4 border-b">{{ r.que_cayo|default:"" }}</td>
            <td class="py-2 px-4 border-b">{{ r.fecha }}</td>
            <td class="py-2 px-4 border-b">{{ r.quien_levanta.get_full_name }}</td>
            <td class="py-2 px-4 border-b">{{ r.observacion|default:"" }}</td>
            <td class="py-2 px-4 border-b">{{ r.personal_sitio|default:"" }}</td>
            <td class="py-2 px-4 border-b">
                {% if r.fecha_levanta %}
                    {{ r.fecha_levanta }}
                {% else %}
                    <span class="bg-warning px-2 py-1 rounded text-dark">
                        Aún sin responder
                    </span>
                {% endif %}
            </td>
            <td class="py-2 px-4 border-b">{{ r.observaciones_finales|default:"" }}</td>
            <td class="py-2 px-4 border-b">
                {% if r.estatus == 1 %}
                    <button
                        class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition"
                        onclick="abrirModalCerrar({{ r.id }})">
                        Cerrar
                    </button>
                {% else %}
                    <span class="text-gray-500">Cerrado</span>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="11" class="py-4 text-center text-gray-500">
                No hay reportes.
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div id="modal-cerrar" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
        <h2 class="text-xl font-bold mb-4">Cerrar Reporte</h2>

        <form id="form-cerrar" method="post">
            {% csrf_token %}

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">
                    Observaciones finales
                </label>
                <textarea
                    name="observaciones_finales"
                    class="w-full border rounded px-3 py-2"
                    rows="4"
                    required></textarea>
            </div>

            <div class="flex justify-end gap-2">
                <button type="button"
                        onclick="cerrarModalCerrar()"
                        class="px-4 py-2 bg-gray-300 rounded">
                    Cancelar
                </button>

                <button type="submit"
                        class="px-4 py-2 bg-green-600 text-white rounded">
                    Confirmar cierre
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function abrirModalCerrar(idReporte) {
    const modal = document.getElementById('modal-cerrar');
    const form = document.getElementById('form-cerrar');

    form.action = `/gestion/api/cerrar_reporte/${idReporte}/`;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function cerrarModalCerrar() {
    const modal = document.getElementById('modal-cerrar');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}
</script>

{% endblock %}
