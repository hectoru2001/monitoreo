{% extends 'base.html' %}
{% load static %}

{% block title %}Reportes{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Reportes</h1>

<!-- FILTROS -->
<form method="get" class="bg-white p-4 mb-4 rounded shadow grid grid-cols-1 md:grid-cols-4 gap-4">

    <input
        type="text"
        name="q"
        value="{{ request.GET.q }}"
        placeholder="Nombre, IP o Referencia"
        class="border rounded px-3 py-2 w-full"
    >

    <select name="estatus" class="border rounded px-3 py-2 w-full">
        <option value="">Todos</option>
        <option value="1" {% if request.GET.estatus == '1' %}selected{% endif %}>Abiertos</option>
        <option value="2" {% if request.GET.estatus == '2' %}selected{% endif %}>Cerrados</option>
    </select>

    <input
        type="date"
        name="fecha_inicio"
        value="{{ request.GET.fecha_inicio }}"
        class="border rounded px-3 py-2 w-full"
    >

    <input
        type="date"
        name="fecha_fin"
        value="{{ request.GET.fecha_fin }}"
        class="border rounded px-3 py-2 w-full"
    >

    <div class="md:col-span-4 flex gap-2">
        <button
            type="submit"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"
        >
            Filtrar
        </button>

        <a
            href="{% url 'reportes' %}"
            class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition"
        >
            Limpiar
        </a>
    </div>
</form>

<!-- TABLA -->
<table class="min-w-full bg-white shadow rounded">
    <thead>
        <tr>
            <th class="py-2 px-4 border-b text-left">ID</th>
            <th class="py-2 px-4 border-b text-left">Nombre</th>
            <th class="py-2 px-4 border-b text-left">IP</th>
            <th class="py-2 px-4 border-b text-left"># Reporte</th>
            <th class="py-2 px-4 border-b text-left">Referencia Caída</th>
            <th class="py-2 px-4 border-b text-left">Fecha de Creación</th>
            <th class="py-2 px-4 border-b text-left">Quién Creó</th>
            <th class="py-2 px-4 border-b text-left">Observaciones</th>
            <th class="py-2 px-4 border-b text-left">Personal en Sitio</th>
            <th class="py-2 px-4 border-b text-left">Fecha Levanta</th>
            <th class="py-2 px-4 border-b text-left">Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for r in reportes %}
        <tr class="hover:bg-gray-100">
            <td class="py-2 px-4 border-b">{{ r.id }}</td>
            <td class="py-2 px-4 border-b">{{ r.nombre }}</td>
            <td class="py-2 px-4 border-b font-mono">{{ r.ip }}</td>
            <td class="py-2 px-4 border-b">{{ r.servicio|default_if_none:"" }}</td>
            <td class="py-2 px-4 border-b">{{ r.que_cayo|default:"" }}</td>
            <td class="py-2 px-4 border-b">{{ r.fecha }}</td>
            <td class="py-2 px-4 border-b">{{ r.quien_levanta.get_full_name }}</td>
            <td class="py-2 px-4 border-b">{{ r.observacion|default:"" }}</td>
            <td class="py-2 px-4 border-b">{{ r.personal_sitio|default:"" }}</td>
            <td class="py-2 px-4 border-b">
                {% if r.fecha_levanta %}
                    {{ r.fecha_levanta }}
                {% else %}
                    <span class="bg-warning px-2 py-1 rounded text-dark">
                        Aún sin responder
                    </span>
                {% endif %}
            </td>
            <td class="py-2 px-4 border-b">
                {% if r.estatus == 1 %}
                    <form method="post" action="{% url 'cerrar_reporte' r.id %}">
                        {% csrf_token %}
                        <button class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition">
                            Cerrar Reporte
                        </button>
                    </form>
                {% else %}
                    <span class="text-gray-500">Reporte Cerrado</span>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="11" class="py-4 text-center text-gray-500">
                No hay reportes.
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}
