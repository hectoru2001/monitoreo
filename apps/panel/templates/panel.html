{% extends "base.html" %}
{% load static %}

{% block title %}Monitoreo de Conexiones{% endblock %}

{% block content %}
<div class="container-fluid mt-2">
    <!-- Header compacto -->
    <header class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h1 class="h4 fw-bold text-primary mb-0">
                <i class="fas fa-network-wired me-2"></i>Monitoreo
            </h1>
            <div class="d-flex align-items-center gap-2">
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="activar-sonidos" style="transform: scale(0.8);">
                    <label class="form-check-label small" for="activar-sonidos">
                        <i class="fas fa-volume-up fa-xs"></i>
                    </label>
                </div>
                <div class="d-flex gap-1">
                    <span class="badge bg-success px-2 py-1">
                        <i class="fas fa-check fa-xs me-1"></i><span id="online-count">0</span>
                    </span>
                    <span class="badge bg-danger px-2 py-1">
                        <i class="fas fa-times fa-xs me-1"></i><span id="offline-count">0</span>
                    </span>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted" id="ultima-actualizacion">Cargando...</small>
            <div id="error-message" class="alert alert-danger d-none py-1 px-2 mb-0 small" role="alert">
                <i class="fas fa-exclamation-triangle fa-xs me-1"></i>Error de conexión
            </div>
        </div>
    </header>

    <!-- Contenedor de tarjetas de servidores -->
    <div id="servidores" class="mb-3">
        <div class="text-center py-2 text-muted small">
            <i class="fas fa-spinner fa-spin me-1"></i>Cargando servidores...
        </div>
    </div>

    <!-- Modal para levantar reporte -->
    <div class="modal fade" id="modal-servidor" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white py-2">
                    <h5 class="modal-title fs-6">
                        <i class="fas fa-file-alt me-1"></i> Levantar reporte
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <form id="form-reporte" class="needs-validation" novalidate>
                    <div class="modal-body p-3">
                        <input type="hidden" name="referencia">
                        <input type="hidden" name="referencia2">
                        
                        <div class="row g-2">
                            <!-- Campos de solo lectura -->
                            <div class="col-md-6">
                                <label class="form-label fw-medium small">Nombre</label>
                                <input type="text" name="nombre" readonly class="form-control form-control-sm bg-light">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-medium small">IP</label>
                                <input type="text" name="ip" readonly class="form-control form-control-sm bg-light">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-medium small">Número de Sitio</label>
                                <input type="text" name="enlace" readonly class="form-control form-control-sm bg-light">
                            </div>
                            
                            <!-- Campos editables -->
                            <div class="col-md-6">
                                <label class="form-label fw-medium small">Número de Reporte</label>
                                <input type="text" name="servicio" class="form-control form-control-sm" required>
                                <div class="invalid-feedback small">
                                    Ingrese número de reporte.
                                </div>
                            </div>
                            
                            <div class="col-md-12">
                                <label class="form-label fw-medium small">Servicio</label>
                                <select name="que_cayo" id="que_cayo" class="form-select form-select-sm" required>
                                    <option value="">Selecciona una opción</option>
                                </select>
                                <div class="invalid-feedback small">
                                    Seleccione un servicio.
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-medium small">Personal en Sitio</label>
                                <input type="text" name="personal_sitio" class="form-control form-control-sm">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-medium small">Teléfono</label>
                                <input type="text" name="telefono_contacto" class="form-control form-control-sm">
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label fw-medium small">Observaciones</label>
                                <textarea name="observacion" rows="2" class="form-control form-control-sm"></textarea>
                            </div>
                        </div>
                        
                        <!-- Información de contacto -->
                        <div class="border rounded bg-light mt-3 p-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-phone-alt text-primary me-2"></i>
                                <span class="fw-semibold small">Contactos de soporte</span>
                            </div>

                            <div class="row small">
                                <div class="col-12 col-md-4 mb-1">
                                    <span class="text-muted">CASE</span><br>
                                    <strong>9018 001 476 500</strong>
                                </div>
                                <div class="col-12 col-md-4 mb-1">
                                    <span class="text-muted">NOC</span><br>
                                    <strong>9339 690 9090</strong>
                                </div>
                                <div class="col-12 col-md-4">
                                    <span class="text-muted">CARE</span><br>
                                    <strong>9018 000 777 00</strong>
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    <div class="modal-footer py-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-save me-1"></i> Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Audio para alertas -->
    <audio id="sonido-alerta" src="{% static 'audio/1.mp3' %}" preload="auto"></audio>
</div>

<script src="{% static 'js/panel.js' %}"></script>

<style>
/* Estilos ultra compactos */
:root {
    --card-height: 60px;
    --card-padding: 0.4rem;
    --grid-gap: 0.4rem;
}

/* Contenedor principal */
.container-fluid {
    padding-left: 0.5rem;
    padding-right: 0.5rem;
}

/* Tarjetas de servidores */
.server-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: var(--grid-gap);
}

.server-card {
    height: var(--card-height);
    padding: var(--card-padding);
    border-radius: 6px;
    border: 1px solid #000000;
    cursor: pointer;
    transition: all 0.15s ease;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
}

.server-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    border-color: #adb5bd;
}

/* Estados de servidor */
.server-card.online { background-color: #96ffce; }
.server-card.inestable { background-color: #ffe69c; }
.server-card.degradado { background-color: #ffbc85; }
.server-card.offline { 
    background-color: #ffa5ae;
    animation: pulse-offline 2s infinite;
}

/* Contenido de tarjeta */
.server-name {
    font-size: 0.75rem;
    font-weight: 600;
    line-height: 1.2;
    margin-bottom: 0.2rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.server-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.server-ip {
    font-family: 'Courier New', monospace;
    font-size: 0.65rem;
    color: #6c757d;
    line-height: 1;
}

.server-status {
    font-size: 0.6rem;
    padding: 0.15rem 0.3rem;
    border-radius: 3px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Colores de estado */
.status-online { background-color: rgba(25, 135, 84, 0.1); color: #198754; }
.status-inestable { background-color: rgba(255, 193, 7, 0.1); color: #ffc107; }
.status-degradado { background-color: rgba(253, 126, 20, 0.1); color: #fd7e14; }
.status-offline { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; }

/* Sección de categoría */
.category-section {
    margin-bottom: 1rem;
}

.category-header {
    font-size: 0.85rem;
    font-weight: 600;
    color: #831f46;
    padding-bottom: 0.3rem;
    margin-bottom: 0.5rem;
    border-bottom: 1px solid rgba(131, 31, 70, 0.2);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.category-count {
    font-size: 0.7rem;
    background: rgba(131, 31, 70, 0.1);
    color: #831f46;
    padding: 0.1rem 0.4rem;
    border-radius: 10px;
}

/* Badges compactos */
.badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
}

/* Modal compacto */
.modal-header {
    padding: 0.5rem 1rem;
}

.modal-body {
    padding: 0.75rem;
}

.modal-footer {
    padding: 0.5rem 0.75rem;
}

.form-control-sm, .form-select-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    border-radius: 0.25rem;
}

.alert {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
}

/* Scrollbar minimalista */
#servidores {
    max-height: calc(100vh - 150px);
    overflow-y: auto;
}

#servidores::-webkit-scrollbar {
    width: 6px;
}

#servidores::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#servidores::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#servidores::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Responsive ultra compacto */
@media (min-width: 576px) {
    .server-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
}

@media (min-width: 768px) {
    .server-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 0.5rem;
    }
    
    .server-card {
        height: 65px;
    }
}

@media (min-width: 992px) {
    .server-grid {
        grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
    }
}

@media (min-width: 1200px) {
    .server-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    }
}

@media (max-width: 576px) {
    .server-grid {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    }
    
    .server-card {
        height: 55px;
        padding: 0.3rem;
    }
    
    .server-name {
        font-size: 0.7rem;
    }
    
    .server-ip {
        font-size: 0.6rem;
    }
    
    .server-status {
        font-size: 0.55rem;
        padding: 0.1rem 0.25rem;
    }
}
</style>

<script>
// Validación del formulario
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('form-reporte');
    
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        form.classList.add('was-validated');
    }, false);
    
    // Tooltips para tarjetas
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            trigger: 'hover'
        });
    });
});
</script>
{% endblock %}